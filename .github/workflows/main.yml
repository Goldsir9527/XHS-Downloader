# 工作流名称：XHS-Downloader 自动打包
name: XHS-Downloader Auto Build

# 触发条件：1. 代码推送到main分支 2. 每日定时检查更新（可选）3. 手动触发
on:
  push:
    branches: [ main ]  # 代码推送到main分支时触发打包
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点（北京时间8点）检查更新并打包（可选）
  workflow_dispatch:  # 允许手动触发打包（方便测试）

# 工作流执行的任务
jobs:
  build:
    # 运行环境：同时打包Windows、macOS、Linux版本
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # 某个系统打包失败不影响其他系统
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      # 步骤1：拉取仓库最新代码
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史，确保获取最新更新

      # 步骤2：配置Python环境
      - name: 配置Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # 适配XHS-Downloader的Python版本（可根据项目调整）

      # 步骤3：安装项目依赖和打包工具PyInstaller
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # 安装项目依赖（核心）
          pip install fastmcp  # 手动安装缺失的fastmcp库（关键新增）
          pip install pyinstaller  # 安装打包工具

      # 步骤4：打包生成可执行文件（关键步骤）
      - name: 打包XHS-Downloader
        run: |
          # 找到项目的主入口文件（通常是main.py/xhs_downloader.py，需根据实际文件调整）
          # --onefile：打包成单个可执行文件；--name：指定打包后的文件名
          pyinstaller --onefile --name XHS-Downloader-${{ matrix.os }} --hidden-import=fastmcp main.py
        # 如果主入口文件不是main.py，替换成项目实际的入口（比如xhs_downloader.py）

      # 步骤5：上传打包后的文件（方便下载）
      - name: 上传打包产物
        uses: actions/upload-artifact@v4
        with:
          name: XHS-Downloader-${{ matrix.os }}  # 按系统命名产物
          path: dist/*  # 打包后的文件会在dist目录下

      # （可选）步骤6：自动发布到GitHub Release（方便长期保存）
      - name: 发布到Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'  # 仅main分支触发
        with:
          files: dist/*
          tag_name: auto-build-${{ github.run_id }}  # 自动生成版本标签
          name: 自动打包-${{ matrix.os }}-${{ github.run_id }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动提供的令牌，无需手动配置
